<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Happy 24th Birthday</title>
    <style>
        :root{
            --char-width: 260px;
            --char-height: 400px;
            --characters-right-gap: 18px;
            --nav-outset: 150px;

            --sasha-tx: -30px;
            --r1-tx: 0px;
            --r2-tx: 0px;
            --r3-tx: 0px;
            --r4-tx: 0px;

            --sasha-ty: 0px;
            --r1-ty: 0px;
            --r2-ty: 0px;
            --r3-ty: 0px;
            --r4-ty: 0px;
        }

        *{ box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body{
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            padding:10px;
            overflow:hidden;
        }

        .game-container{
            width:100%; max-width:1200px; background:transparent; overflow:visible;
            position:relative; min-height:800px; height:90vh;
        }

        .game-header{
            background: linear-gradient(90deg,#667eea,#764ba2);
            padding:15px 20px; color:white; font-weight:bold; font-size:20px;
            display:flex; align-items:center; justify-content:center; position:relative; min-height:70px; z-index:100;
        }

        /* menu button fixed */
        .back-to-menu-btn{
            position:fixed; top:12px; left:12px;
            background:rgba(255,255,255,0.95); border:2px solid white; color:#667eea;
            padding:8px 14px; border-radius:12px; cursor:pointer; z-index:9999; font-weight:700;
            box-shadow:0 6px 20px rgba(0,0,0,0.15);
        }

        .game-content{ position:relative; height:calc(100% - 70px); overflow:hidden; }

        .background{ position:absolute; top:0; left:0; width:100%; height:100%; background-size:cover; background-position:center; z-index:1; }

        .characters{
            position:absolute; bottom:0; left:0; width:100%; height:70%;
            display:flex; justify-content:space-between; align-items:flex-end; padding:20px; z-index:2; pointer-events:none;
        }

        .character{
            width:var(--char-width); height:var(--char-height); background-size:contain; background-repeat:no-repeat; background-position:bottom center;
            transition: transform .2s ease, opacity .2s ease; display:none; pointer-events:auto;
            transform: translateX(var(--tx,0px)) translateY(var(--ty,0px)) scale(1);
            opacity: 1;
        }
        .character:hover{ transform: translateX(var(--tx,0px)) translateY(var(--ty,0px)) scale(1.06); }
        .character-right{ display:flex; gap:var(--characters-right-gap); align-items:flex-end; }

        .dialogue-container{ position:relative; z-index:3; padding:20px 20px 140px 20px; height:100%; display:flex; flex-direction:column; justify-content:flex-end; overflow-y:auto; pointer-events:auto; }

        .dialogue-box{
            background: rgba(255,255,255,0.92); border-radius:18px; padding:16px 18px; margin-bottom:18px;
            box-shadow:0 8px 25px rgba(0,0,0,0.15); border:1px solid rgba(224,224,224,0.9); max-width:85%;
            animation: fadeInUp .35s ease-out; backdrop-filter: blur(2px); position:relative;
        }
        /* –∏—Ç–æ–≥–æ–≤—ã–µ –±–æ–∫—Å—ã –±—É–¥—É—Ç –∏–º–µ—Ç—å –∫–ª–∞—Å—Å result-box ‚Äî —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Ö —É–¥–∞–ª—è—Ç—å –ø–æ –æ—á–µ—Ä–µ–¥–∏ */
        .dialogue-box.result-box { border-color: rgba(200,120,120,0.12); }
        .dialogue-container .dialogue-box:last-child{ margin-bottom:-48px; }
        @keyframes fadeInUp{ from{opacity:0; transform:translateY(18px);} to{opacity:1; transform:translateY(0);} }

        .character-name{ font-weight:700; color:#667eea; margin-bottom:8px; font-size:18px; }
        .dialogue-text{ font-size:18px; line-height:1.6; color:#333; }
        .thoughts{ font-style:italic; color:#666; }

        /* –í–ï–†–ù–£–õ –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–û–ö –ú–ï–ù–Æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ "—Å—Ç—Ä–∞—à–Ω–æ–π" –∫–Ω–æ–ø–∫–∏) */
        .menu-btn{
            background: linear-gradient(90deg,#667eea,#764ba2);
            color:white; border:none; padding:18px 50px; border-radius:30px;
            font-size:20px; cursor:pointer; margin:15px; font-weight:600; min-width:220px;
            box-shadow:0 8px 25px rgba(0,0,0,0.3);
        }
        .menu-btn.secondary{ background:transparent; border:2px solid #667eea; color:#667eea; }

        .choices-container{ position:absolute; bottom:150px; left:0; width:100%; display:flex; flex-direction:column; gap:15px; z-index:4; padding:0 30px; }
        .choice-btn{ background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; padding:18px 30px; border-radius:15px; font-size:17px; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,0.2); align-self:center; max-width:720px; }

        .lives{ position:absolute; top:15px; right:20px; background:#ff6b6b; color:white; padding:8px 15px; border-radius:12px; font-weight:bold; z-index:100; }

        .hidden{ display:none !important; }
        .screen{ height:100%; display:flex; flex-direction:column; }

        .start-screen{ background:white; border-radius:25px; box-shadow:0 25px 50px rgba(0,0,0,0.4); }
        .menu-container{ flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:40px; text-align:center; }
        .menu-title{ font-size:36px; margin-bottom:25px; color:#333; text-shadow:2px 2px 4px rgba(0,0,0,0.1); }
        .menu-subtitle{ font-size:17px; line-height:1.7; color:#555; margin-bottom:40px; max-width:700px; }

        .navigation-container{ position:absolute; top:50%; left: calc(-1 * var(--nav-outset)); width:calc(100% + (var(--nav-outset) * 2)); transform:translateY(-50%); display:flex; justify-content:space-between; z-index:200; pointer-events:none; padding:0 10px; }
        .nav-btn{ background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; padding:14px 35px; border-radius:20px; cursor:pointer; font-size:18px; font-weight:600; box-shadow:0 8px 25px rgba(0,0,0,0.3); pointer-events:auto; }
        .nav-btn:disabled{ background:#ccc; cursor:not-allowed; box-shadow:none; }

        .stage-info{ font-size:16px; opacity:0.95; }

        .life-hit{
            position:absolute; top:18px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.95);
            border:2px solid rgba(0,0,0,0.08); padding:8px 14px; border-radius:18px; z-index:999; display:flex; gap:10px; align-items:center;
            font-weight:700; color:#c0392b; box-shadow:0 10px 30px rgba(0,0,0,0.12); opacity:0; transition:opacity .25s ease, transform .35s cubic-bezier(.2,.8,.2,1);
        }
        .life-hit.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

        @media (max-width:720px){ :root{ --char-width:140px; --char-height:220px; --nav-outset:60px; } .dialogue-box{ max-width:92%; font-size:16px; } }
    </style>
</head>
<body>
<div class="game-container">
    <button class="back-to-menu-btn" onclick="saveAndReturnToMenu()">‚Üê –ú–µ–Ω—é</button>

    <div id="life-hit" class="life-hit" aria-hidden="true"><span style="font-size:20px;">üíî</span><span>-1 –∂–∏–∑–Ω—å</span></div>

    <div id="start-screen" class="screen start-screen">
        <div class="menu-container">
            <h1 class="menu-title">Happy 24th Birthday</h1>
            <p class="menu-subtitle">
                –ü—Ä–∏–≤–µ—Ç! –°–µ–≥–æ–¥–Ω—è —Ç–≤–æ–π –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –∏ —è –±—ã –æ—á–µ–Ω—å —Ö–æ—Ç–µ–ª–∞ –ø—Ä–æ–≤–µ—Å—Ç–∏ –µ–≥–æ —Å —Ç–æ–±–æ–π. –•–æ—Ç—å —Å–µ–π—á–∞—Å –º—ã –Ω–µ —Ä—è–¥–æ–º, —è –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª–∞ –¥–ª—è —Ç–µ–±—è –ø–æ–¥–∞—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–±–µ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –Ω–∞–π—Ç–∏.
                –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –∏–≥—Ä–∞, –≥–¥–µ —Ç—ã —Å—ã–≥—Ä–∞–µ—à—å –∑–∞ —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –ø—Ä–æ–π—Ç–∏ –ø—É—Ç—å –¥–æ 24-–ª–µ—Ç–∏—è, –¥–µ–ª–∞—è –Ω–∞ —Å–≤–æ–µ–º –∂–∏–∑–Ω–µ–Ω–Ω–æ–º –ø—É—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤—ã–±–æ—Ä—ã. –£ —Ç–µ–±—è –µ—Å—Ç—å 3 –∂–∏–∑–Ω–∏: –µ—Å–ª–∏ —Ç—ã –∏—Ö –ø–æ—Ç–µ—Ä—è–µ—à—å, —Ç–æ –∏–≥—Ä–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è, –∏ –ø—Ä–∏–¥–µ—Ç—Å—è –Ω–∞—á–∞—Ç—å –≤—Å–µ —Å–Ω–∞—á–∞–ª–∞. –í –∫–æ–Ω—Ü–µ —Ç—ã —É–≤–∏–¥–∏—à—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥: –æ—Ç–ø—Ä–∞–≤—å –µ–≥–æ –º–Ω–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫. –£–¥–∞—á–∏! ‚ù§Ô∏è‚Äçüî•
            </p>
            <button class="menu-btn" onclick="startNewGame()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
            <button class="menu-btn secondary" onclick="continueGame()" id="continue-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div class="game-header">
            <span class="stage-info" id="stage-info">–≠—Ç–∞–ø ‚Ññ1  –í–æ–∑—Ä–∞—Å—Ç: 7 –ª–µ—Ç  –ú–µ—Å—Ç–æ: –ú—É—Ä–º–∞–Ω—Å–∫, –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∞—è —É–ª.</span>
            <div class="lives">–ñ–∏–∑–Ω–∏: <span id="lives-count">3</span></div>
        </div>

        <div class="game-content">
            <div class="background" id="background" style="background-image:url('https://raw.githubusercontent.com/Psina1/Psina1.github.io/main/images/Murmansk-7-let.png');"></div>

            <div class="characters">
                <div class="character character-left" id="sasha" style="--tx:var(--sasha-tx); --ty:var(--sasha-ty); background-image:url('https://raw.githubusercontent.com/Psina1/Psina1.github.io/main/images/%D0%A1%D0%B0%D1%88%D0%B0%20(%D1%8D%D1%82%D0%B0%D0%BF%201).png');"></div>

                <div class="character-right">
                    <div class="character" id="mama-happy" style="--tx:var(--r1-tx); --ty:var(--r1-ty); background-image:url('https://raw.githubusercontent.com/Psina1/Psina1.github.io/main/images/%D0%9C%D0%B0%D0%BC%D0%B0%20%D1%80%D0%B0%D0%B4%D0%BE%D1%81%D1%82%D0%BD%D0%B0%D1%8F%20(%D1%8D%D1%82%D0%B0%D0%BF%201)%20(1).png');"></div>
                    <div class="character" id="dima" style="--tx:var(--r2-tx); --ty:var(--r2-ty); background-image:url('https://raw.githubusercontent.com/Psina1/Psina1.github.io/main/images/%D0%94%D0%B8%D0%BC%D0%B0%20(%D1%8D%D1%82%D0%B0%D0%BF%201).png');"></div>
                    <div class="character" id="mama-angry" style="--tx:var(--r3-tx); --ty:var(--r3-ty); background-image:url('https://raw.githubusercontent.com/Psina1/Psina1.github.io/main/images/%D0%9C%D0%B0%D0%BC%D0%B0%20%D1%81%D0%B5%D1%80%D0%B4%D0%B8%D1%82%D0%B0%D1%8F%20(%D1%8D%D1%82%D0%B0%D0%BF%201)%20(1).png');"></div>
                    <div class="character" id="sasha-think" style="--tx:var(--r4-tx); --ty:var(--r4-ty); background-image:url('https://raw.githubusercontent.com/Psina1/Psina1.github.io/main/images/%D0%A1%D0%B0%D1%88%D0%B0%20%D0%B4%D1%83%D0%BC%D0%B0%D0%B5%D1%82%20(%D1%8D%D1%82%D0%B0%D0%BF%201).png');"></div>
                </div>
            </div>

            <div class="dialogue-container" id="dialogue-container"></div>
            <div class="choices-container hidden" id="choices-container"></div>
        </div>

        <div class="navigation-container" id="nav-container">
            <button class="nav-btn" id="prev-btn" onclick="handlePrev()" disabled>‚Üê –ù–∞–∑–∞–¥</button>
            <button class="nav-btn" id="next-btn" onclick="handleNext()">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
    </div>
</div>

<script>
/* ====== –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã ====== */
const SAVE_KEY = 'birthday_story_save';

let gameData = {
    currentStage: 1,
    currentDialogueIndex: 0,
    lives: 3,
    completedStages: [],
    choices: {}
};

/* playState: 'dialogue' | 'choices' | 'results' */
let playState = 'dialogue';
let resultQueue = [];
let resultIndex = -1;

const stages = {
    1: {
        title: "–≠—Ç–∞–ø ‚Ññ1  –í–æ–∑—Ä–∞—Å—Ç: 7 –ª–µ—Ç  –ú–µ—Å—Ç–æ: –ú—É—Ä–º–∞–Ω—Å–∫, –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∞—è —É–ª.",
        background: "https://raw.githubusercontent.com/Psina1/Psina1.github.io/main/images/Murmansk-7-let.png",
        dialogues: [
            { character: "–ú–∞–º–∞", text: "¬´–°–∞—à–∞, –º–Ω–µ –Ω—É–∂–Ω–æ —Å—Ö–æ–¥–∏—Ç—å –≤ –ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫—É—é. –ë—É–¥—å –¥–æ–±—Ä, –ø—Ä–∏—Å–º–æ—Ç—Ä–∏ –∑–∞ –î–∏–º–æ–π. –û–Ω –º–∞–ª–µ–Ω—å–∫–∏–π, –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å¬ª", activeCharacter: "mama-happy" },
            { character: "–°–∞—à–∞", text: "¬´–ú–∞–∞–º, –Ω—É —è –∂–µ —Ö–æ—á—É —Å —Ä–µ–±—è—Ç–∞–º–∏ –≤ —Ñ—É—Ç–±–æ–ª –ø–æ–∏–≥—Ä–∞—Ç—å‚Ä¶¬ª", activeCharacter: "sasha" },
            { character: "–î–∏–º–∞ (—Ç—è–Ω–µ—Ç –∑–∞ —Ä—É–∫—É)", text: "¬´–°–∞—à, –ø–æ—à–ª–∏ –≥—É–ª—è—Ç—å! –ù–∞ —É–ª–∏—Ü–µ —Ç–∞–∫ —Ç–µ–ø–ª–æ!¬ª", activeCharacter: "dima" },
            { character: "–ú–∞–º–∞ (—Å—Ç—Ä–æ–≥–æ)", text: "¬´–¢—ã —Å—Ç–∞—Ä—à–∏–π –±—Ä–∞—Ç. –ù–∞ —Ç–µ–±–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.¬ª", activeCharacter: "mama-angry" },
            { character: "–°–∞—à–∞ (–¥—É–º–∞–µ—Ç)", text: "¬´–≠—Ö, –∫–∞–∫ –∂–µ –±—ã—Ç—å?..¬ª", isThought: true, activeCharacter: "sasha-think" }
        ],
        choices: [
            { text: "–ü—Ä–∏—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞ –î–∏–º–æ–π –∏ –ø–æ–π—Ç–∏ —Å –Ω–∏–º –≥—É–ª—è—Ç—å", type: "good" },
            { text: "–£–±–µ–∂–∞—Ç—å –∫ –¥—Ä—É–∑—å—è–º –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –î–∏–º—É", type: "bad" }
        ],
        // (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –º–æ–∂–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å resultImages –∑–¥–µ—Å—å –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏:
        resultImages: [
            'https://github.com/Psina1/Psina1.github.io/blob/main/images/%D0%94%D0%B8%D0%BC%D0%B0%20(%D1%8D%D1%82%D0%B0%D0%BF%201).png?raw=true',
            'https://github.com/Psina1/Psina1.github.io/blob/main/images/%D0%9C%D0%B0%D0%BC%D0%B0%20%D1%80%D0%B0%D0%B4%D0%BE%D1%81%D1%82%D0%BD%D0%B0%D1%8F%20(%D1%8D%D1%82%D0%B0%D0%BF%201)%20(1).png?raw=true',
            'https://github.com/Psina1/Psina1.github.io/blob/main/images/%D0%94%D0%B8%D0%BC%D0%B0%20%D0%BF%D0%BB%D0%B0%D1%87%D0%B5%D1%82%20(%D1%8D%D1%82%D0%B0%D0%BF%201).png?raw=true',
            'https://github.com/Psina1/Psina1.github.io/blob/main/images/%D0%9C%D0%B0%D0%BC%D0%B0%20%D1%81%D0%B5%D1%80%D0%B4%D0%B8%D1%82%D0%B0%D1%8F%20(%D1%8D%D1%82%D0%B0%D0%BF%201)%20(1).png?raw=true'
        ]
    }
};

/* ====== –£—Ç–∏–ª–∏—Ç—ã ====== */
function toRawGitHub(url){
    try{
        const u = new URL(url);
        if(u.hostname.includes('github.com') && u.pathname.includes('/blob/')){
            const parts = u.pathname.split('/');
            const user = parts[1], repo = parts[2], branch = parts[4];
            const path = parts.slice(5).join('/');
            return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
        }
        return url.split('?')[0];
    }catch(e){
        return url;
    }
}

function safeUrlForCss(url){
    try {
        return encodeURI(url);
    } catch(e){
        return url;
    }
}

function preloadImage(url){
    try{
        const img = new Image();
        img.src = toRawGitHub(url);
    }catch(e){
        console.warn('preloadImage error', e, url);
    }
}

function preloadStageAssets(stage){
    if(!stage) return;
    // —Ñ–æ–Ω
    if(stage.background) preloadImage(stage.background);

    // —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ background'—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–∑ DOM
    document.querySelectorAll('.character').forEach(ch=>{
        const bg = ch.style.backgroundImage;
        if(bg){
            const m = bg.match(/url\((['"]?)(.*?)\1\)/);
            if(m && m[2]) preloadImage(m[2]);
        }
    });

    // –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Ç–æ–≥–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã
    if(stage.resultImages && Array.isArray(stage.resultImages)){
        stage.resultImages.forEach(u => preloadImage(u));
    }
}

function loadSave(){
    const s = localStorage.getItem(SAVE_KEY);
    if(s){ gameData = {...JSON.parse(s)}; return true; }
    return false;
}
function saveGame(){ localStorage.setItem(SAVE_KEY, JSON.stringify(gameData)); }

/* ====== –≠–∫—Ä–∞–Ω –∏ –∑–∞–ø—É—Å–∫ ====== */
function showStart(){
    const has = loadSave();
    const cb = document.getElementById('continue-btn');
    if(has && gameData.currentDialogueIndex > 0){
        cb.style.display = 'block';
        cb.textContent = `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å (–≠—Ç–∞–ø ${gameData.currentStage})`;
    } else cb.style.display = 'none';
    showScreen('start-screen');
}
function showScreen(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}
function startNewGame(){ gameData = {currentStage:1, currentDialogueIndex:0, lives:3, completedStages:[], choices:{}}; localStorage.removeItem(SAVE_KEY); startGame(); }
function continueGame(){ loadSave(); startGame(); }
function saveAndReturnToMenu(){ saveGame(); showStart(); }

/* ====== –ó–∞–ø—É—Å–∫ —ç—Ç–∞–ø–∞ ====== */
function startGame(){
    showScreen('game-screen');
    const stage = stages[gameData.currentStage];
    document.getElementById('stage-info').textContent = stage.title;
    document.getElementById('background').style.backgroundImage = `url('${toRawGitHub(stage.background)}')`;
    document.getElementById('lives-count').textContent = gameData.lives;
    document.getElementById('dialogue-container').innerHTML = '';
    document.getElementById('choices-container').classList.add('hidden');

    document.getElementById('prev-btn').disabled = gameData.currentDialogueIndex <= 0;
    document.getElementById('next-btn').disabled = false;
    document.getElementById('next-btn').textContent = '–î–∞–ª–µ–µ ‚Üí';
    document.getElementById('nav-container').classList.remove('hidden');

    hideAllCharacters();

    // –≤–∞–∂–Ω–æ ‚Äî –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ–Ω/—Å–ø—Ä–∞–π—Ç—ã/–∏—Ç–æ–≥–æ–≤—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —ç—Ç–∞–ø–∞ —á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å –ø–æ–∫–∞–∑ –ø–æ–∑–∂–µ
    preloadStageAssets(stage);

    const dlgCount = stage.dialogues.length;
    if(gameData.currentDialogueIndex >= dlgCount){
        prepareChoices();
        return;
    }

    playState = 'dialogue';
    resultQueue = [];
    resultIndex = -1;

    showDialogueAt(gameData.currentDialogueIndex, false);
}

/* ====== –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –∏ –¥–∏–∞–ª–æ–≥–∏ ====== */
function hideAllCharacters(){ document.querySelectorAll('.character').forEach(c=>c.style.display='none'); }
function showCharacter(id){
    hideAllCharacters();
    const el = document.getElementById(id);
    if(el) el.style.display = 'block';
}

function showDialogueAt(index, animate=true){
    const stage = stages[gameData.currentStage];
    if(!stage || index<0 || index>=stage.dialogues.length) return;
    const d = stage.dialogues[index];
    const container = document.getElementById('dialogue-container');
    container.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'dialogue-box';
    if(animate){ box.style.opacity='0'; box.style.transform='translateY(20px)'; }
    const nameLabel = d.isThought ? '–¥—É–º–∞–µ—Ç:' : `${d.character}:`;
    box.innerHTML = `<div class="character-name ${d.isThought ? 'thoughts' : ''}">${nameLabel}</div><div class="dialogue-text">${d.text}</div>`;
    container.appendChild(box);

    if(d.activeCharacter) showCharacter(d.activeCharacter);

    if(animate){
        setTimeout(()=>{ box.style.opacity='1'; box.style.transform='translateY(0)'; box.style.transition='opacity .28s ease, transform .28s ease'; },10);
    }
    box.scrollIntoView({behavior:'smooth'});

    document.getElementById('prev-btn').disabled = index <= 0;
    document.getElementById('next-btn').disabled = false;

    gameData.currentDialogueIndex = index;
    saveGame();
}

/* ====== –ù–∞–≤–∏–≥–∞—Ü–∏—è ====== */
function handleNext(){
    if(playState === 'dialogue'){
        const stage = stages[gameData.currentStage];
        const dlgCount = stage.dialogues.length;
        if(gameData.currentDialogueIndex < dlgCount - 1){
            showDialogueAt(gameData.currentDialogueIndex + 1, true);
        } else {
            gameData.currentDialogueIndex = dlgCount;
            saveGame();
            prepareChoices();
        }
    } else if(playState === 'results'){
        // –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Next: —Å–∫—Ä—ã—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π result (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π
        if(resultIndex < resultQueue.length - 1){
            // –µ—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω –∫–∞–∫–æ–π-—Ç–æ ‚Äî —É–¥–∞–ª–∏–º –µ–≥–æ
            removeCurrentResultBox();
            resultIndex++;
            showResultItem(resultQueue[resultIndex]);
            // –µ—Å–ª–∏ —Ç–µ–ø–µ—Ä—å –ø–æ—Å–ª–µ–¥–Ω–∏–π ‚Äî –ø–æ–º–µ–Ω—è–µ–º –Ω–∞–¥–ø–∏—Å—å
            if(resultIndex === resultQueue.length - 1){
                document.getElementById('next-btn').textContent = '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ 2–π —ç—Ç–∞–ø';
            } else {
                document.getElementById('next-btn').textContent = '–î–∞–ª–µ–µ ‚Üí';
            }
        } else {
            // –µ—Å–ª–∏ –≤—Å–µ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º
            goToNextStageOrEnd();
        }
    }
}

function handlePrev(){
    if(playState === 'results'){
        if(resultIndex >= 0){
            removeCurrentResultBox();
            resultIndex--;
            if(resultIndex >= 0){
                showResultItem(resultQueue[resultIndex]);
                document.getElementById('next-btn').textContent = (resultIndex === resultQueue.length - 1) ? '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ 2–π —ç—Ç–∞–ø' : '–î–∞–ª–µ–µ ‚Üí';
            } else {
                playState = 'dialogue';
                const stage = stages[gameData.currentStage];
                const lastIdx = stage.dialogues.length - 1;
                showDialogueAt(lastIdx, true);
            }
        } else {
            playState = 'dialogue';
            const stage = stages[gameData.currentStage];
            const lastIdx = stage.dialogues.length - 1;
            showDialogueAt(lastIdx, true);
        }
    } else {
        const stage = stages[gameData.currentStage];
        const dlgCount = stage.dialogues.length;
        if(gameData.currentDialogueIndex > 0 && gameData.currentDialogueIndex <= dlgCount - 1){
            showDialogueAt(gameData.currentDialogueIndex - 1, true);
        } else if(gameData.currentDialogueIndex === dlgCount){
            showDialogueAt(dlgCount - 1, true);
        }
    }
}

/* —É–¥–∞–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π result-box (–µ—Å–ª–∏ –µ—Å—Ç—å) */
function removeCurrentResultBox(){
    const container = document.getElementById('dialogue-container');
    const boxes = container.querySelectorAll('.dialogue-box.result-box');
    if(boxes.length){
        const last = boxes[boxes.length - 1];
        container.removeChild(last);
    }
    // —Å–ø—Ä—è—á–µ–º –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π
    hideAllCharacters();
}

/* ====== –í—ã–±–æ—Ä ====== */
function prepareChoices(){
    const stage = stages[gameData.currentStage];
    const choicesContainer = document.getElementById('choices-container');
    choicesContainer.innerHTML = '';
    stage.choices.forEach(choice=>{
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = choice.text;
        btn.onclick = ()=> makeChoice(choice.type);
        choicesContainer.appendChild(btn);
    });
    choicesContainer.classList.remove('hidden');

    playState = 'choices';
    document.getElementById('next-btn').disabled = true;
    document.getElementById('prev-btn').disabled = stage.dialogues.length <= 0;
}

/* ====== –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏ –∏ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ ====== */
function preloadResults(items){
    items.forEach(it=>{
        if(it.imgUrl){
            preloadImage(it.imgUrl);
        }
    });
}

function queueResults(items){
    resultQueue = items.slice();
    resultIndex = -1;
    playState = 'results';
    document.getElementById('next-btn').disabled = false;
    document.getElementById('next-btn').textContent = '–î–∞–ª–µ–µ ‚Üí';
    document.getElementById('prev-btn').disabled = false;

    // –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî —á—Ç–æ–±—ã –ø–µ—Ä–≤–∞—è –∏—Ç–æ–≥–æ–≤–∞—è —Ä–µ–ø–ª–∏–∫–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –±—ã—Å—Ç—Ä–æ
    preloadResults(items);
}

/* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–Ω—É –∏—Ç–æ–≥–æ–≤—É—é —Ä–µ–ø–ª–∏–∫—É ‚Äî —Å—Ç–∞–≤–∏–º —Ñ–æ–Ω —Å—Ä–∞–∑—É (—á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–∞—á–∞–ª –∑–∞–≥—Ä—É–∑–∫—É),
   –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å—Ä–∞–∑—É (fallback) –∏ –∑–∞—Ç–µ–º –ø–ª–∞–≤–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø–æ–∫–∞–∑ –ø–æ onload */
function showResultItem(item){
    hideAllCharacters();

    const container = document.getElementById('dialogue-container');

    // —É–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π result-box (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è)
    removeCurrentResultBox();

    // —Å–æ–∑–¥–∞—ë–º result-box –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –∂–¥–∞–ª –∫–∞—Ä—Ç–∏–Ω–∫–∏)
    const box = document.createElement('div');
    box.className = 'dialogue-box result-box';
    box.innerHTML = `<div class="character-name">${item.name}:</div><div class="dialogue-text">${item.text}</div>`;
    container.appendChild(box);
    box.scrollIntoView({behavior:'smooth'});

    if(item.characterId){
        const el = document.getElementById(item.characterId);
        if(!el) return;

        if(item.imgUrl){
            const url = toRawGitHub(item.imgUrl);
            // —Å—Ç–∞–≤–∏–º background –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å ‚Äî –±—Ä–∞—É–∑–µ—Ä –Ω–∞—á–Ω—ë—Ç/–ø—Ä–æ–¥–æ–ª–∂–∏—Ç –∑–∞–≥—Ä—É–∑–∫—É
            el.style.backgroundImage = `url("${safeUrlForCss(url)}")`;
            // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å—Ä–∞–∑—É (fallback)
            el.style.display = 'block';

            // –µ—Å–ª–∏ —Ä–µ—Å—É—Ä—Å —É–∂–µ –≤ –∫–µ—à–µ ‚Äî probe.complete –±—É–¥–µ—Ç true
            const probe = new Image();
            let loaded = false;
            probe.onload = () => {
                loaded = true;
                el.style.opacity = '1';
            };
            probe.onerror = () => {
                loaded = true;
                el.style.opacity = '1';
                console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–π —Ä–µ–ø–ª–∏–∫–∏:', url);
            };
            // —É—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è
            el.style.opacity = '0';
            el.style.transition = 'opacity .28s ease';
            probe.src = url;

            if(probe.complete){
                // –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
                el.style.opacity = '1';
                loaded = true;
            }

            // safety fallback: –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≤–∏—Å–ª–∞ ‚Äî —á–µ—Ä–µ–∑ 700ms –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
            setTimeout(()=>{
                if(!loaded){
                    el.style.opacity = '1';
                }
            }, 700);
        } else {
            el.style.display = 'block';
            el.style.opacity = '1';
        }
    }
}

/* ====== –ü–ª–∞—à–∫–∞ -1 –∂–∏–∑–Ω—å ====== */
function showLifeHit(){
    const el = document.getElementById('life-hit');
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');
    setTimeout(()=>{ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }, 1400);
}

/* ====== –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–∞ ====== */
function makeChoice(choiceType){
    const stage = stages[gameData.currentStage];
    const choicesContainer = document.getElementById('choices-container');
    choicesContainer.classList.add('hidden');

    let items = [];
    if(choiceType === 'good'){
        items.push({
            characterId: 'dima',
            name: '–î–∏–º–∞ (—Å–º–µ—ë—Ç—Å—è)',
            text: '¬´–£—Ä–∞! –¢—ã —Å–∞–º—ã–π –ª—É—á—à–∏–π –±—Ä–∞—Ç!¬ª',
            imgUrl: 'https://github.com/Psina1/Psina1.github.io/blob/main/images/%D0%94%D0%B8%D0%BC%D0%B0%20(%D1%8D%D1%82%D0%B0%D0%BF%201).png?raw=true'
        });
        items.push({
            characterId: 'mama-happy',
            name: '–ú–∞–º–∞ (—É–ª—ã–±–∞–µ—Ç—Å—è)',
            text: '¬´–°–ø–∞—Å–∏–±–æ, –°–∞—à–∞. –í–æ—Ç —Ç–∞–∫ –∏ –¥–æ–ª–∂–µ–Ω –ø–æ—Å—Ç—É–ø–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π –º—É–∂—á–∏–Ω–∞.¬ª',
            imgUrl: 'https://github.com/Psina1/Psina1.github.io/blob/main/images/%D0%9C%D0%B0%D0%BC%D0%B0%20%D1%80%D0%B0%D0%B4%D0%BE%D1%81%D1%82%D0%BD%D0%B0%D1%8F%20(%D1%8D%D1%82%D0%B0%D0%BF%201)%20(1).png?raw=true'
        });
    } else {
        // –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π: -1 –∂–∏–∑–Ω—å
        gameData.lives--;
        document.getElementById('lives-count').textContent = gameData.lives;
        showLifeHit();

        items.push({
            characterId: 'dima',
            name: '–î–∏–º–∞ (–ø–ª–∞—á–µ—Ç)',
            text: '¬´–¢—ã –æ–±–µ—â–∞–ª‚Ä¶¬ª',
            imgUrl: 'https://github.com/Psina1/Psina1.github.io/blob/main/images/%D0%94%D0%B8%D0%BC%D0%B0%20%D0%BF%D0%BB%D0%B0%D1%87%D0%B5%D1%82%20(%D1%8D%D1%82%D0%B0%D0%BF%201).png?raw=true'
        });
        items.push({
            characterId: 'mama-angry',
            name: '–ú–∞–º–∞ (—Å–µ—Ä–¥–∏—Ç–æ)',
            text: '¬´–°–∞—à–∞, —è –Ω–∞ —Ç–µ–±—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª–∞. –û—á–µ–Ω—å –∂–∞–ª—å.¬ª',
            imgUrl: 'https://github.com/Psina1/Psina1.github.io/blob/main/images/%D0%9C%D0%B0%D0%BC%D0%B0%20%D1%81%D0%B5%D1%80%D0%B4%D0%B8%D1%82%D0%B0%D1%8F%20(%D1%8D%D1%82%D0%B0%D0%BF%201)%20(1).png?raw=true'
        });
    }

    gameData.choices[gameData.currentStage] = choiceType;
    gameData.completedStages.push(gameData.currentStage);
    saveGame();

    // –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—á–µ—Ä–µ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    queueResults(items);

    // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∏—Ç–æ–≥–æ–≤—É—é —Ä–µ–ø–ª–∏–∫—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞:
    if(resultQueue.length){
        resultIndex = 0;
        showResultItem(resultQueue[0]);
        if(resultQueue.length === 1){
            document.getElementById('next-btn').textContent = '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ 2–π —ç—Ç–∞–ø';
        } else {
            document.getElementById('next-btn').textContent = '–î–∞–ª–µ–µ ‚Üí';
        }
    }

    playState = 'results';

    if(gameData.lives <= 0){
        setTimeout(()=>{ alert('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ –≤—Å–µ –∂–∏–∑–Ω–∏.'); startNewGame(); }, 900);
    }
}

/* ====== –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É ====== */
function goToNextStageOrEnd(){
    const next = gameData.currentStage + 1;
    if(stages[next]){
        gameData.currentStage = next;
        gameData.currentDialogueIndex = 0;
        saveGame();
        startGame();
    } else {
        showStart();
    }
}

/* ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====== */
window.onload = showStart;
</script>
</body>
</html>
